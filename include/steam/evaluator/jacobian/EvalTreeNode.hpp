//////////////////////////////////////////////////////////////////////////////////////////////
/// \file EvalTreeNode.hpp
///
/// \author Sean Anderson, ASRL
//////////////////////////////////////////////////////////////////////////////////////////////

#ifndef STEAM_EVAL_TREE_NODE_HPP
#define STEAM_EVAL_TREE_NODE_HPP

#include <steam/evaluator/jacobian/EvalTreeNodeBase.hpp>

#include <steam/common/Pool.hpp>

namespace steam {

//////////////////////////////////////////////////////////////////////////////////////////////
/// \brief Simple structure to hold Jacobian information
//////////////////////////////////////////////////////////////////////////////////////////////
template <typename TYPE>
class EvalTreeNode : public EvalTreeNodeBase
{
 public:

  //////////////////////////////////////////////////////////////////////////////////////////////
  /// \brief Default constructor
  //////////////////////////////////////////////////////////////////////////////////////////////
  EvalTreeNode();

  //////////////////////////////////////////////////////////////////////////////////////////////
  /// \brief Default constructor
  //////////////////////////////////////////////////////////////////////////////////////////////
  EvalTreeNode(const TYPE& value);

  //////////////////////////////////////////////////////////////////////////////////////////////
  /// \brief Destructor
  //////////////////////////////////////////////////////////////////////////////////////////////
  virtual ~EvalTreeNode() {}

  //////////////////////////////////////////////////////////////////////////////////////////////
  /// \brief Use when node was allocated using a pool. This function causes the object to
  ///        release itself back to the pool it was allocated from. While the user is
  ///        responsible for releasing the top level node, this interface method is required
  ///        in order for this node to release its children.
  //////////////////////////////////////////////////////////////////////////////////////////////
  virtual void release();

  //////////////////////////////////////////////////////////////////////////////////////////////
  /// \brief Release children and reset internals.
  //////////////////////////////////////////////////////////////////////////////////////////////
  virtual void reset();

  /////////////////////////////////////////////////////////////////////////////////////////////
  /// \brief Get current value
  /////////////////////////////////////////////////////////////////////////////////////////////
  const TYPE& getValue() const;

  /////////////////////////////////////////////////////////////////////////////////////////////
  /// \brief Set current value
  /////////////////////////////////////////////////////////////////////////////////////////////
  void setValue(const TYPE& value);

  /////////////////////////////////////////////////////////////////////////////////////////////
  /// \brief Static instance of OpenMP-enabled pool
  /////////////////////////////////////////////////////////////////////////////////////////////
  #ifdef _OPENMP
  static OmpPool<EvalTreeNode<TYPE> > pool;
  #else
  static Pool<EvalTreeNode<TYPE> > pool;
  #endif

 private:

  /////////////////////////////////////////////////////////////////////////////////////////////
  /// \brief Instance of TYPE
  /////////////////////////////////////////////////////////////////////////////////////////////
  TYPE value_;

 public:
  EIGEN_MAKE_ALIGNED_OPERATOR_NEW
};

} // steam

#include <steam/evaluator/jacobian/EvalTreeNode-inl.hpp>

#endif // STEAM_EVAL_TREE_NODE_HPP
