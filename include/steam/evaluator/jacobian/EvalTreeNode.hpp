//////////////////////////////////////////////////////////////////////////////////////////////
/// \file EvalTreeNode.hpp
///
/// \author Sean Anderson, ASRL
//////////////////////////////////////////////////////////////////////////////////////////////

#ifndef STEAM_EVAL_TREE_NODE_HPP
#define STEAM_EVAL_TREE_NODE_HPP

#include <steam/evaluator/jacobian/EvalTreeNodeBase.hpp>

#include <steam/common/Pool.hpp>

namespace steam {

//////////////////////////////////////////////////////////////////////////////////////////////
/// \brief Simple structure to hold Jacobian information
//////////////////////////////////////////////////////////////////////////////////////////////
template <typename TYPE>
class EvalTreeNode : public EvalTreeNodeBase
{
 public:

  //////////////////////////////////////////////////////////////////////////////////////////////
  /// \brief Default constructor
  //////////////////////////////////////////////////////////////////////////////////////////////
  EvalTreeNode();

  //////////////////////////////////////////////////////////////////////////////////////////////
  /// \brief Default constructor
  //////////////////////////////////////////////////////////////////////////////////////////////
  EvalTreeNode(const TYPE& value);

  //////////////////////////////////////////////////////////////////////////////////////////////
  /// \brief Destructor
  //////////////////////////////////////////////////////////////////////////////////////////////
  virtual ~EvalTreeNode() {}

  // a method we must implement for pool... pool calls this when we return the object..
  void reset() {
    // Note that we choose not to reset the value_ memory, as it is always set by the getter
    EvalTreeNodeBase::reset();
  }

  // tell object to release itself back to the pool it came from ...
  // this method is required in order to release the children contained by the base class
  virtual void release() {
    return pool.returnObj(this);
  }

  /////////////////////////////////////////////////////////////////////////////////////////////
  /// \brief Get current value
  /////////////////////////////////////////////////////////////////////////////////////////////
  const TYPE& getValue() const;

  /////////////////////////////////////////////////////////////////////////////////////////////
  /// \brief Set current value
  /////////////////////////////////////////////////////////////////////////////////////////////
  void setValue(const TYPE& value);

  /// static pool
  //static Pool<EvalTreeNode<TYPE> > pool;
  static OmpPool<EvalTreeNode<TYPE> > pool;

 private:

  /////////////////////////////////////////////////////////////////////////////////////////////
  /// \brief Instance of TYPE
  /////////////////////////////////////////////////////////////////////////////////////////////
  TYPE value_;

 public:
  EIGEN_MAKE_ALIGNED_OPERATOR_NEW
};

} // steam

#include <steam/evaluator/jacobian/EvalTreeNode-inl.hpp>

#endif // STEAM_EVAL_TREE_NODE_HPP
