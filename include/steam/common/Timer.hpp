//////////////////////////////////////////////////////////////////////////////////////////////
/// \file Timer.hpp
/// \brief Implements a basic timer tool.
///
/// \author Sean Anderson, ASRL
//////////////////////////////////////////////////////////////////////////////////////////////

#ifndef STEAM_TIMER_HPP
#define STEAM_TIMER_HPP

// system timer
#include <sys/time.h>
#include <iostream>
#include <boost/cstdint.hpp>

namespace steam {

//////////////////////////////////////////////////////////////////////////////////////////////
/// \brief Simple wall timer class to get approximate timings of functions
//////////////////////////////////////////////////////////////////////////////////////////////
class Timer
{
 public:
  //////////////////////////////////////////////////////////////////////////////////////////////
  /// \brief Default constructor
  //////////////////////////////////////////////////////////////////////////////////////////////
  Timer() {
    reset();
  }

  //////////////////////////////////////////////////////////////////////////////////////////////
  /// \brief Reset timer
  //////////////////////////////////////////////////////////////////////////////////////////////
  void reset() {
    beg_ = this->get_wall_time();
  }

  //////////////////////////////////////////////////////////////////////////////////////////////
  /// \brief Get seconds since last reset
  //////////////////////////////////////////////////////////////////////////////////////////////
  double seconds() const {
    return this->get_wall_time() - beg_;
  }

  //////////////////////////////////////////////////////////////////////////////////////////////
  /// \brief Get milliseconds since last reset
  //////////////////////////////////////////////////////////////////////////////////////////////
  double milliseconds() const {
    return 1000.0*(this->get_wall_time() - beg_);
  }

 private:

  //////////////////////////////////////////////////////////////////////////////////////////////
  /// \brief Get current wall time
  //////////////////////////////////////////////////////////////////////////////////////////////
  double get_wall_time() const {
    struct timeval time;
    if (gettimeofday(&time,NULL)){
      //  Handle error
      return 0;
    }
    return (double)time.tv_sec + (double)time.tv_usec * .000001;
  }

  //////////////////////////////////////////////////////////////////////////////////////////////
  /// \brief Wall time at reset
  //////////////////////////////////////////////////////////////////////////////////////////////
  double beg_;

};

//////////////////////////////////////////////////////////////////////////////////////////////
/// \brief Time class
//////////////////////////////////////////////////////////////////////////////////////////////
struct Time {


  Time(boost::int64_t nsecs) : nsecs_(nsecs) {}
  //Time(boost::int32_t secs, boost::int32_t nsecs);
  //Time(double secs);

  // may lose precision going to double if in unix epochs...
  // in most cases it is okay since we subtract two values and then get a shorter duration.
  double seconds() { // TODO -- test this for precision...
    return double(nsecs_)*1e-9;
  }

  // int64 gives nanosecond precision since epoch (+/- ~9.2e18)...
  // which covers the ~1.5e9 seconds since epoch and 1e9 nsecs
  boost::int64_t nsecs_;

  //todo overload minus op
};

} // steam

#endif // STEAM_TIMER_HPP
