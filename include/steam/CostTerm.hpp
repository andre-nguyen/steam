//////////////////////////////////////////////////////////////////////////////////////////////
/// \file CostTerm.hpp
///
/// \author Sean Anderson, ASRL
//////////////////////////////////////////////////////////////////////////////////////////////

#ifndef STEAM_COST_TERM_HPP
#define STEAM_COST_TERM_HPP

#include <boost/shared_ptr.hpp>

#include <steam/evaluator/ErrorEvaluator.hpp>
#include <steam/NoiseModel.hpp>
#include <steam/LossFunctions.hpp>

namespace steam {

//////////////////////////////////////////////////////////////////////////////////////////////
/// \brief Class that fully defines a nonlinear cost term (or 'factor').
///        Cost terms are composed of an error function, loss function and noise model.
//////////////////////////////////////////////////////////////////////////////////////////////
class CostTerm
{
public:

  /// Convenience typedefs
  typedef boost::shared_ptr<CostTerm> Ptr;
  typedef boost::shared_ptr<const CostTerm> ConstPtr;

  //////////////////////////////////////////////////////////////////////////////////////////////
  /// \brief Constructor
  //////////////////////////////////////////////////////////////////////////////////////////////
  CostTerm(const ErrorEvaluatorX::ConstPtr& errorFunction, const NoiseModel::ConstPtr& noiseModel, const LossFunction::ConstPtr& lossFunc);

  //////////////////////////////////////////////////////////////////////////////////////////////
  /// \brief Evaluate the cost of this term. Error is first whitened by the noise model
  ///        and then passed through the loss function, as in:
  ///          cost = loss(sqrt(e^T * cov^{-1} * e))
  //////////////////////////////////////////////////////////////////////////////////////////////
  double evaluate() const;

  //////////////////////////////////////////////////////////////////////////////////////////////
  /// \brief Evaluate the iteratively reweighted error vector and Jacobians. The error and
  ///        Jacobians are first whitened by the noise model and then weighted by the loss
  ///        function, as in:
  ///              error = sqrt(weight)*sqrt(cov^-1)*rawError
  ///           jacobian = sqrt(weight)*sqrt(cov^-1)*rawJacobian
  //////////////////////////////////////////////////////////////////////////////////////////////
  Eigen::VectorXd evalWeightedAndWhitened(std::vector<Jacobian<> >* outJacobians) const;

private:

  //////////////////////////////////////////////////////////////////////////////////////////////
  /// \brief Error evaluator
  //////////////////////////////////////////////////////////////////////////////////////////////
  ErrorEvaluatorX::ConstPtr errorFunction_;

  //////////////////////////////////////////////////////////////////////////////////////////////
  /// \brief Noise model
  //////////////////////////////////////////////////////////////////////////////////////////////
  NoiseModel::ConstPtr noiseModel_;

  //////////////////////////////////////////////////////////////////////////////////////////////
  /// \brief Loss function
  //////////////////////////////////////////////////////////////////////////////////////////////
  LossFunction::ConstPtr lossFunc_;

};

} // steam

#endif // STEAM_COST_TERM_HPP
